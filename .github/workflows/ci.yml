name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PHP_VERSION: "8.4"
  NODE_VERSION: "22"

jobs:
  quality:
    name: ${{ matrix.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Laravel Pint
            command: composer test:lint
            needs-node: "true"
            cache-path: ""
            cache-key: ""
          - name: PHPStan
            command: composer test:types
            needs-node: "false"
            cache-path: /tmp/phpstan
            cache-key: phpstan
          - name: Type Coverage
            command: composer test:type-coverage
            needs-node: "false"
            cache-path: ""
            cache-key: ""
          - name: Composer Validate & Audit
            command: |
              composer validate
              composer audit || {
                EXIT_CODE=$?
                echo "⚠️  Composer audit found vulnerabilities."
                # Check if output contains high or critical severity
                if composer audit 2>&1 | grep -qiE "(severity.*high|severity.*critical)"; then
                  echo "❌ Found high or critical severity vulnerabilities - failing!"
                  exit 1
                else
                  echo "ℹ️  Only low/moderate severity vulnerabilities found (non-blocking)"
                  exit 0
                fi
              }
            needs-node: "false"
            cache-path: ""
            cache-key: ""

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup
        with:
          flux-username: ${{ secrets.FLUX_USERNAME }}
          flux-license-key: ${{ secrets.FLUX_LICENSE_KEY }}
          pureline-username: ${{ secrets.PURELINE_USERNAME }}
          pureline-license-key: ${{ secrets.PURELINE_LICENSE_KEY }}

      - name: Install Composer Dependencies
        run: composer install --no-progress --no-interaction --prefer-dist --optimize-autoloader

      - name: Cache Node.js dependencies
        if: matrix.needs-node == 'true'
        uses: actions/cache@v5
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-

      - name: Install Node Dependencies
        if: matrix.needs-node == 'true'
        run: npm ci

      - name: Cache Tool
        if: matrix.cache-path != ''
        uses: actions/cache@v5
        with:
          path: ${{ matrix.cache-path }}
          key: ${{ runner.os }}-${{ matrix.cache-key }}-${{ hashFiles('composer.lock') }}
          restore-keys: ${{ runner.os }}-${{ matrix.cache-key }}-

      - name: Run ${{ matrix.name }}
        run: ${{ matrix.command }}

  tests:
    name: Tests
    runs-on: ubuntu-latest

    env:
      DB_CONNECTION: pgsql
      DB_HOST: 127.0.0.1
      DB_PORT: 5432
      DB_DATABASE: testing
      DB_USERNAME: sail
      DB_PASSWORD: password

    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_USER: sail
          POSTGRES_DB: testing
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup
        with:
          flux-username: ${{ secrets.FLUX_USERNAME }}
          flux-license-key: ${{ secrets.FLUX_LICENSE_KEY }}
          pureline-username: ${{ secrets.PURELINE_USERNAME }}
          pureline-license-key: ${{ secrets.PURELINE_LICENSE_KEY }}

      - name: Install Composer Dependencies
        run: composer install --no-progress --no-interaction --prefer-dist --optimize-autoloader

      - name: Cache Node.js dependencies
        uses: actions/cache@v5
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-

      - name: Install Node Dependencies
        run: npm ci

      - name: Build Assets
        run: npm run build

      - name: Cache Rector
        uses: actions/cache@v5
        with:
          path: /tmp/rector
          key: ${{ runner.os }}-rector-${{ hashFiles('composer.lock') }}
          restore-keys: ${{ runner.os }}-rector-

      - name: Cache PHPStan
        uses: actions/cache@v5
        with:
          path: /tmp/phpstan
          key: ${{ runner.os }}-phpstan-${{ hashFiles('composer.lock') }}
          restore-keys: ${{ runner.os }}-phpstan-

      - name: Run Pest Tests
        run: composer test:unit
